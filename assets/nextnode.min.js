(function($){Drupal.nextNode={defaults:{hookSelector:".nextnode-wrapper",nextSelector:".nextnode-next",contentSelector:".nextnode-node",loadOffset:200,scrollOffset:100,autoTrigger:true,autoTriggerUntil:null,updatePageInfo:true,stickyTitle:true,stickyZindex:null,stickyTop:null,stickyOffset:-100,statsURL:null,countStatistics:false,gaTrackPageView:false},options:{},settings:{},context:null,element:null,loadingElement:null,titleElement:null,stickyElement:null,stickyTitleElement:null,stickyMeterElement:null,infinite:null,activeNode:null,currentPage:0,init:function(element,context,settings){this.options=$.extend({},this.defaults,settings.NextNode);this.settings=settings;this.context=context;this.element=element;this.loadingElement=$("#nextnode-loading",context);this.titleElement=$("title",context);this.initWaypoint();if(this.options.stickyTitle){this.initSticky()}this.initScroll($(this.options.contentSelector,context))},initWaypoint:function(){var nn=this;this.infinite=new Waypoint.Infinite({element:nn.element,items:nn.options.contentSelector,more:nn.options.nextSelector,onBeforePageLoad:function(){nn.loadingElement.show()},onAfterPageLoad:function($items){nn.loadingElement.hide();$(nn.options.nextSelector,nn.context).hide();nn.initNodes($items);nn.currentPage++;if(!nn.options.autoTrigger||nn.options.autoTriggerUntil!==null&&nn.currentPage>=nn.options.autoTriggerUntil){nn.infinite.waypoint.disable();nn.loadOnClick()}},offset:function(){return this.context.innerHeight()+nn.options.loadOffset-this.adapter.outerHeight()}});if(this.options.autoTrigger){$(this.options.nextSelector,this.context).hide()}else{this.infinite.waypoint.disable();this.loadOnClick()}},initNodes:function($items){var nn=this;$items.each(function(){var $node=$(this);nn.initScroll($node);$node.on("nextnode.firstscrollin",function(event){if(nn.options.countStatistics&&nn.options.statsURL!==null){nn.updateStats($node)}if(nn.options.gaTrackPageView&&typeof ga==="function"){nn.trackPageView($node)}});Drupal.attachBehaviors(this,nn.settings);$node.trigger("nextnode.load")})},initScroll:function($node){var nn=this;var Inview=new Waypoint.Inview({element:$node[0],enter:function(direction){if(direction==="down"){$node.trigger("nextnode.firstscrollin").off("nextnode.firstscrollin")}if(direction==="up"){nn.activeNode=$node.data("nid");nn.updatePageInfo($node)}$node.trigger("nextnode.scrollin",direction)},exit:function(direction){if(direction==="down"){nn.activeNode=$node.data("nid");nn.updatePageInfo($node)}},exited:function(direction){$node.trigger("nextnode.scrollout",direction)},offset:{top:nn.options.scrollOffset,bottom:nn.options.scrollOffset}})},initSticky:function(){var nn=this;this.stickyElement=$("#nextnode-sticky",this.context);if(!this.stickyElement.length){this.options.stickyTitle=false;return}this.stickyTitleElement=$("#nextnode-sticky-title",this.context);this.stickyMeterElement=$("#nextnode-sticky-meter",this.context);if(this.options.stickyZindex!==null){this.stickyElement.css("z-index",this.options.stickyZindex)}if(this.options.stickyTop!==null){this.stickyElement.css("top",this.options.stickyTop+"px")}var Sticky=new Waypoint.Sticky({element:this.stickyElement[0],stuckClass:"nextnodesticky--active",wrapper:'<div class="nextnodesticky__wrapper" />',offset:this.options.stickyOffset});$(Sticky.waypoint.context.element).on("scroll.waypoints",function(){if(nn.activeNode===null){return false}var $this=$(this);$(nn.options.contentSelector,nn.context).each(function(){var $node=$(this);if($node.data("nid")===nn.activeNode){nn.resizeMeter($node,$this.scrollTop());return false}})})},loadOnClick:function(){var nn=this;$(this.options.nextSelector).on("click",function(event){event.preventDefault();nn.infinite.waypoint.callback();return false}).show()},resizeMeter:function($item,windowTop){var elementTop=$item.offset().top-this.options.scrollOffset;var itemHeight=$item.height();var elementBottom=elementTop+itemHeight;var percent=0;if(windowTop>=elementTop&&windowTop<=elementBottom){percent=((windowTop-elementTop)/itemHeight||0)*100}else if(windowTop>elementBottom){percent=100}this.stickyMeterElement.css("width",percent+"%")},updatePageInfo:function($node){var title=$node.data("title");if(this.titleElement.text()!==title){if(this.options.updatePageInfo){history.pushState(null,title,$node.data("url"));this.titleElement.html(title)}if(this.options.stickyTitle){this.stickyTitleElement.html(title)}}},updateStats:function($node){$.ajax({type:"POST",cache:false,url:this.options.statsURL,data:{nid:$node.data("nid")}})},trackPageView:function($node){ga("set","page",$node.data("path"));ga("set","title",$node.data("title"));ga("send","pageview")}};Drupal.behaviors.nextnode={attach:function(context,settings){if(settings&&typeof settings.NextNode!=="undefined"){$(settings.NextNode.hookSelector,context).once("nextnode",function(){if(typeof settings.statistics!=="undefined"){settings.NextNode.statsURL=settings.statistics.url}Drupal.nextNode.init(this,context,settings)})}}}})(jQuery);